import{c as la,j as e,B as $,U as ca,r as m,C as Aa,a as ka,b as Ta,d as $e,e as P,R as Fe,f as Ea,A as ea,g as Me,h as aa,i as ye,L as B,I as re,S as pa,k as $a,l as xa,V as sa,F as Fa,m as Sa,n as ta,o as Ge,P as ra,p as H,q as C,s as I,t as be,u as R,w as v,v as _,x as Da,y as Ma,z as J,D as Ra,E as Ha,G as _a,H as ge,J as fa,K as ba,T as ga,M as ya,N as Be,O as q,Q as Na,W as O,X as ja,Y as va,Z as te,_ as Ee,$ as Ke,a0 as Xe,a1 as Ye,a2 as Je,a3 as Ie,a4 as We}from"./index-COWPSwuG.js";import{U as Ne,C as oa,a as da,L as Ca}from"./user-x-Ca6qzlEV.js";import{P as na,f as oe}from"./format-B6mXiQzZ.js";/**
 * @license lucide-react v0.483.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const La=[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M7 12h10",key:"b7w52i"}],["path",{d:"M10 18h4",key:"1ulq68"}]],Ba=la("ListFilter",La);/**
 * @license lucide-react v0.483.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const za=[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]],Ze=la("SquarePen",za);/**
 * @license lucide-react v0.483.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qa=[["path",{d:"M11.5 15H7a4 4 0 0 0-4 4v2",key:"15lzij"}],["path",{d:"M21.378 16.626a1 1 0 0 0-3.004-3.004l-4.01 4.012a2 2 0 0 0-.506.854l-.837 2.87a.5.5 0 0 0 .62.62l2.87-.837a2 2 0 0 0 .854-.506z",key:"1817ys"}],["circle",{cx:"10",cy:"7",r:"4",key:"e45bow"}]],ia=la("UserPen",qa),Oa=({status:A,caseCount:T})=>{const p=()=>{switch(A){case"available":return e.jsx(Ne,{className:"h-3.5 w-3.5 text-green-600"});case"busy":return e.jsx(ca,{className:"h-3.5 w-3.5 text-red-600"});case"unavailable":return e.jsx(da,{className:"h-3.5 w-3.5 text-gray-600"});case"on_break":return e.jsx(oa,{className:"h-3.5 w-3.5 text-amber-600"});default:return e.jsx(Ne,{className:"h-3.5 w-3.5 text-blue-600"})}},U=()=>{switch(A){case"available":return e.jsx($,{className:"text-xs bg-green-100 text-green-800 border-green-200",children:"Available"});case"busy":return e.jsx($,{className:"text-xs bg-red-100 text-red-800 border-red-200",children:"Busy"});case"unavailable":return e.jsx($,{className:"text-xs bg-gray-100 text-gray-800 border-gray-200",children:"Unavailable"});case"on_break":return e.jsx($,{className:"text-xs bg-amber-100 text-amber-800 border-amber-200",children:"On Break"});default:return e.jsx($,{variant:"outline",className:"text-xs",children:"Unknown"})}},V=()=>T==null?null:T>=10?e.jsxs($,{className:"text-xs bg-red-100 text-red-800 border-red-200 ml-1",children:[T,"/10"]}):T>=6?e.jsxs($,{className:"text-xs bg-amber-100 text-amber-800 border-amber-200 ml-1",children:[T,"/10"]}):e.jsxs($,{className:"text-xs bg-green-100 text-green-800 border-green-200 ml-1",children:[T,"/10"]});return e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"flex items-center",children:[p(),e.jsx("span",{className:"ml-1",children:U()})]}),V()]})},Ua=({status:A,caseCount:T})=>{const p=()=>{switch(A){case"available":return e.jsx(Ne,{className:"h-3.5 w-3.5 text-green-600"});case"busy":return e.jsx(ca,{className:"h-3.5 w-3.5 text-red-600"});case"unavailable":return e.jsx(da,{className:"h-3.5 w-3.5 text-gray-600"});case"on_break":return e.jsx(oa,{className:"h-3.5 w-3.5 text-amber-600"});default:return e.jsx(Ne,{className:"h-3.5 w-3.5 text-blue-600"})}},U=()=>{switch(A){case"available":return e.jsx($,{className:"text-xs bg-green-100 text-green-800 border-green-200",children:"Available"});case"busy":return e.jsx($,{className:"text-xs bg-red-100 text-red-800 border-red-200",children:"Busy"});case"unavailable":return e.jsx($,{className:"text-xs bg-gray-100 text-gray-800 border-gray-200",children:"Unavailable"});case"on_break":return e.jsx($,{className:"text-xs bg-amber-100 text-amber-800 border-amber-200",children:"On Break"});default:return e.jsx($,{variant:"outline",className:"text-xs",children:"Unknown"})}},V=()=>T==null?null:T>=10?e.jsxs($,{className:"text-xs bg-red-100 text-red-800 border-red-200 ml-1",children:[T,"/10"]}):T>=6?e.jsxs($,{className:"text-xs bg-amber-100 text-amber-800 border-amber-200 ml-1",children:[T,"/10"]}):e.jsxs($,{className:"text-xs bg-green-100 text-green-800 border-green-200 ml-1",children:[T,"/10"]});return e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"flex items-center",children:[p(),e.jsx("span",{className:"ml-1",children:U()})]}),V()]})},Va=({currentUser:A,onCreateCase:T})=>{const[p,U]=m.useState({patients:[{patientName:"",emrNumber:"",chiefComplaint:""}],consultationType:"tele",contactInfo:"",notes:""}),[V,W]=m.useState(new Map),[je,ve]=m.useState(0),[M,de]=m.useState(new Map),[Ce,Z]=m.useState(new Map),Re=()=>{U(s=>({...s,patients:[...s.patients,{patientName:"",emrNumber:"",chiefComplaint:""}]}))},ma=s=>{p.patients.length!==1&&U(t=>({...t,patients:t.patients.filter((r,n)=>n!==s)}))},we=(s,t,r)=>{U(n=>{const i=[...n.patients];return i[s]={...i[s],[t]:r},{...n,patients:i}}),t==="emrNumber"&&S("")},[Q,Se]=m.useState(!1),[le,ze]=m.useState(!1),[me,S]=m.useState(""),[f,De]=m.useState(null),[g,ue]=m.useState(null),[ua,ha]=m.useState(!1),[G,He]=m.useState(!1),[N,F]=m.useState([]),[L,K]=m.useState([]),[Pe,ne]=m.useState(!0),[he,_e]=m.useState(!0),[X,z]=m.useState(!1),[ee,Le]=m.useState(null),[ae,pe]=m.useState(null),[ce,qe]=m.useState(null),se=s=>{if(!s)return!1;const t=M.get(s.id)??s.caseCount??0,r=s.availabilityStatus==="unavailable"||s.availabilityStatus==="on_break",n=t>=10;return!r&&!n},ie=s=>{if(!s)return!1;const t=Ce.get(s.id)??s.caseCount??0,r=s.availabilityStatus==="unavailable"||s.availabilityStatus==="on_break",n=t>=10;return!r&&!n},Ae=async()=>{const s=Date.now();if(s-je<2e3){console.log("Debouncing doctor reassignment attempt");return}if(X){console.log("Already reassigning doctor, skipping");return}ve(s),z(!0),console.log("Doctor became unavailable/at capacity, attempting reassignment...");try{const t=await Promise.all(N.map(async r=>{const n=R(_(C,"cases"),v("assignedDoctors.primary","==",r.id),v("doctorCompleted","==",!1),v("isIncomplete","!=",!0)),i=await J(n);return{...r,caseCount:i.docs.length}}));F(t),await fe(ce),f?console.log(`Successfully reassigned to doctor: ${f.name}`):S("Your assigned doctor became unavailable and no replacement could be found. Please try again later.")}catch(t){console.error("Error during doctor reassignment:",t),S("Failed to reassign doctor. Please refresh and try again.")}finally{z(!1)}},ke=async()=>{const s=Date.now();if(s-je<2e3){console.log("Debouncing pharmacist reassignment attempt");return}if(X){console.log("Already reassigning pharmacist, skipping");return}ve(s),z(!0),console.log("Pharmacist became unavailable/at capacity, attempting reassignment...");try{const t=await Promise.all(L.map(async r=>{const n=R(_(C,"cases"),v("pharmacistId","==",r.id),v("pharmacistCompleted","==",!1),v("isIncomplete","!=",!0)),i=await J(n);return{...r,caseCount:i.docs.length}}));K(t),await a(ce),g?console.log(`Successfully reassigned to pharmacist: ${g.name}`):S("Your assigned pharmacist became unavailable and no replacement could be found. Please try again later.")}catch(t){console.error("Error during pharmacist reassignment:",t),S("Failed to reassign pharmacist. Please refresh and try again.")}finally{z(!1)}},Oe=s=>{if(ee&&ee(),!s)return;const t=H(C,"users",s),r=be(t,c=>{if(c.exists()){const x=c.data();f&&f.id===s&&(De(b=>({...b,availabilityStatus:x.availabilityStatus||"available"})),(x.availabilityStatus==="unavailable"||x.availabilityStatus==="on_break")&&(console.log(`Doctor ${x.name} status changed to unavailable`),Ae())),F(b=>b.map(D=>D.id===s?{...D,availabilityStatus:x.availabilityStatus||"available"}:D))}}),n=R(_(C,"cases"),v("assignedDoctors.primary","==",s),v("doctorCompleted","==",!1),v("isIncomplete","!=",!0)),i=be(n,c=>{const x=c.docs.length;console.log(`Doctor ${s} case count updated: ${x}/10`),de(b=>new Map(b.set(s,x))),f&&f.id===s&&(De(b=>({...b,caseCount:x})),x>=10&&(console.log(`Doctor ${s} reached capacity (${x}/10)`),Ae())),F(b=>b.map(D=>D.id===s?{...D,caseCount:x}:D))}),o=()=>{r(),i()};Le(()=>o)},xe=s=>{if(ae&&ae(),!s)return;const t=H(C,"users",s),r=be(t,c=>{if(c.exists()){const x=c.data();g&&g.id===s&&(ue(b=>({...b,availabilityStatus:x.availabilityStatus||"available"})),(x.availabilityStatus==="unavailable"||x.availabilityStatus==="on_break")&&(console.log(`Pharmacist ${x.name} status changed to unavailable`),ke())),K(b=>b.map(D=>D.id===s?{...D,availabilityStatus:x.availabilityStatus||"available"}:D))}}),n=R(_(C,"cases"),v("pharmacistId","==",s),v("pharmacistCompleted","==",!1),v("isIncomplete","!=",!0)),i=be(n,c=>{const x=c.docs.length;console.log(`Pharmacist ${s} case count updated: ${x}/10`),Z(b=>new Map(b.set(s,x))),g&&g.id===s&&(ue(b=>({...b,caseCount:x})),x>=10&&(console.log(`Pharmacist ${s} reached capacity (${x}/10)`),ke())),K(b=>b.map(D=>D.id===s?{...D,caseCount:x}:D))}),o=()=>{r(),i()};pe(()=>o)},Ue=s=>{V.forEach(r=>r());const t=new Map;s.forEach(r=>{const n=R(_(C,"cases"),v("assignedDoctors.primary","==",r),v("doctorCompleted","==",!1),v("isIncomplete","!=",!0)),i=be(n,o=>{const c=o.docs.length;de(x=>new Map(x.set(r,c))),F(x=>x.map(b=>b.id===r?{...b,caseCount:c}:b)),f&&f.id===r&&c>=10&&(console.log(`Assigned doctor ${r} reached capacity, triggering reassignment`),Ae())});t.set(r,i)}),W(t)},Ve=s=>{s.forEach(t=>{const r=R(_(C,"cases"),v("pharmacistId","==",t),v("pharmacistCompleted","==",!1),v("isIncomplete","!=",!0));be(r,n=>{const i=n.docs.length;Z(o=>new Map(o.set(t,i))),K(o=>o.map(c=>c.id===t?{...c,caseCount:i}:c)),g&&g.id===t&&i>=10&&(console.log(`Assigned pharmacist ${t} reached capacity, triggering reassignment`),ke())})})};m.useEffect(()=>{(async()=>{try{const t=H(C,"users",A.uid),r=await I(t);if(!r.exists())return;const n=r.data();if(qe(n),n.assignedPharmacists)await Qe(n),await a(n);else if(n.reportingTo){const i=H(C,"users",n.reportingTo),o=await I(i);if(o.exists()){const c=o.data();ue({id:o.id,name:c.name,type:"primary",availabilityStatus:c.availabilityStatus||"available",caseCount:0})}}if(n.assignedDoctors)await Te(n);else if(n.reportingTo){const i=H(C,"users",n.reportingTo),o=await I(i);if(o.exists()){const c=o.data();await Te(c),await fe(c)}}}catch(t){console.error("Error fetching assigned professionals:",t)}})()},[A.uid]),m.useEffect(()=>(f&&f.id&&Oe(f.id),()=>{ee&&ee()}),[f==null?void 0:f.id]),m.useEffect(()=>(g&&g.id&&xe(g.id),()=>{ae&&ae()}),[g==null?void 0:g.id]),m.useEffect(()=>()=>{ee&&ee(),ae&&ae()},[]);const Te=async s=>{try{const t=s.assignedDoctors||{},r=R(_(C,"users"),v("role","==","doctor")),n=await J(r),i=[],o=[];n.docs.forEach(c=>{const x=c.data();i.push({id:c.id,name:x.name,availabilityStatus:x.availabilityStatus||"available",caseCount:0,isHierarchy:c.id===t.primary?"primary":c.id===t.secondary?"secondary":c.id===t.tertiary?"tertiary":null}),o.push(c.id)}),F(i),Ue(o),await fe(s)}catch(t){console.error("Error fetching doctors:",t)}},Qe=async s=>{try{const t=s.assignedPharmacists||{},r=R(_(C,"users"),v("role","==","pharmacist")),n=await J(r),i={},o=[];n.docs.forEach(c=>{const x=c.data();i[c.id]={id:c.id,name:x.name,availabilityStatus:x.availabilityStatus||"available",isHierarchy:c.id===t.primary?"primary":c.id===t.secondary?"secondary":c.id===t.tertiary?"tertiary":null,caseCount:0},o.push(c.id)}),K(Object.values(i)),Ve(o)}catch(t){console.error("Error fetching pharmacists:",t)}},fe=async s=>{ha(!0);try{let t=[],r=s.assignToAnyDoctor||!1;if(ne(r),s.assignedDoctors&&Object.keys(s.assignedDoctors).length>0){const h=s.assignedDoctors;h.primary&&t.push(h.primary),h.secondary&&t.push(h.secondary),h.tertiary&&t.push(h.tertiary);for(let l=4;;l++){const d=Y(l);if(h[d])t.push(h[d]);else break}h.assignToAnyDoctor!==void 0&&(r=h.assignToAnyDoctor),console.log("Doctor Hierarchy Config:",{hierarchyArray:t,hierarchyNames:t.map((l,d)=>`${Y(d+1)}: ${l}`),assignToAnyDoctor:r})}else if(s.doctorHierarchy&&Array.isArray(s.doctorHierarchy))t=s.doctorHierarchy,console.log("Doctor Hierarchy Array:",{hierarchyArray:t,hierarchyNames:t.map((h,l)=>`${Y(l+1)}: ${h}`),assignToAnyDoctor:r});else{console.error("No doctor assignments found in data"),S("No doctors configured. Please contact support.");return}if(t.length===0){console.error("No doctors assigned in the hierarchy"),S("No doctors configured in your hierarchy. Please contact support.");return}const n=R(_(C,"users"),v("role","==","doctor")),i=await J(n),o={};i.docs.forEach(h=>{const l=h.data();o[h.id]={id:h.id,name:l.name||"Doctor",availabilityStatus:l.availabilityStatus||"available",caseCount:l.caseCount||0}});const c=R(_(C,"cases"),v("doctorCompleted","==",!1));if((await J(c)).docs.forEach(h=>{var d;const l=h.data();if((d=l.assignedDoctors)!=null&&d.primary){const k=l.assignedDoctors.primary;o[k]&&(o[k].caseCount=(o[k].caseCount||0)+1)}}),!Object.values(o).some(h=>se(h))){console.error("No available doctors found in the system"),S("All doctors are currently unavailable or at capacity. Please try again later.");return}F(Object.values(o));const D=(h,l)=>{const d=o[h];if(!d)return!1;let k=Y(l+1);return De({id:h,name:d.name,type:k,availabilityStatus:d.availabilityStatus,caseCount:d.caseCount||0}),!0};for(let h=0;h<t.length;h++){const l=t[h],d=o[l];if(d&&se(d))return D(l,h)}if(r){const h=Object.values(o).filter(l=>t.includes(l.id)?!1:se(l)).sort((l,d)=>(l.caseCount||0)-(d.caseCount||0));if(h.length>0){const l=h[0];return console.log(`Assigning to fallback doctor ${l.name}`),D(l.id,t.length)}}console.log("No available doctors found"),S("No available doctors found. All doctors are unavailable or at capacity.")}catch(t){console.error("Error finding doctor:",t),S("Failed to find available doctor. Please try again.")}};m.useEffect(()=>()=>{V.forEach(s=>s())},[]);const Y=s=>{switch(s){case 1:return"primary";case 2:return"secondary";case 3:return"tertiary";case 4:return"quaternary";case 5:return"quinary";default:return`level-${s}`}},a=async s=>{var t;He(!0);try{let r=[],n=s.assignToAnyPharmacist||((t=s.assignedPharmacists)==null?void 0:t.assignToAnyPharmacist)||!1;if(_e(n),s.assignedPharmacists&&Object.keys(s.assignedPharmacists).length>0){const l=s.assignedPharmacists;l.primary&&r.push(l.primary),l.secondary&&r.push(l.secondary),l.tertiary&&r.push(l.tertiary);for(let d=4;;d++){const k=Y(d);if(l[k])r.push(l[k]);else break}console.log("Pharmacist Hierarchy Config:",{hierarchyArray:r,hierarchyNames:r.map((d,k)=>`${Y(k+1)}: ${d}`),assignToAnyPharmacist:n})}else s.pharmacistHierarchy&&Array.isArray(s.pharmacistHierarchy)&&(r=s.pharmacistHierarchy,console.log("Pharmacist Hierarchy Array:",{hierarchyArray:r,hierarchyNames:r.map((l,d)=>`${Y(d+1)}: ${l}`),assignToAnyPharmacist:n}));if(r.length===0){console.error("No pharmacists assigned in the hierarchy");return}const i=R(_(C,"users"),v("role","==","pharmacist")),o=await J(i),c={};o.docs.forEach(l=>{const d=l.data();c[l.id]={id:l.id,name:d.name||"Pharmacist",availabilityStatus:d.availabilityStatus||"available",caseCount:d.caseCount||0}});const x=R(_(C,"cases"),v("pharmacistCompleted","==",!1),v("isIncomplete","!=",!0));if((await J(x)).docs.forEach(l=>{const d=l.data();if(d.pharmacistId){const k=d.pharmacistId;c[k]&&(c[k].caseCount=(c[k].caseCount||0)+1)}}),!Object.values(c).some(l=>ie(l))){console.error("No available pharmacists found in the system"),S("All pharmacists are currently unavailable or at capacity. Please try again later.");return}K(Object.values(c));const h=(l,d)=>{const k=c[l];if(!k)return!1;let Pa=Y(d+1);return ue({id:l,name:k.name,type:Pa,availabilityStatus:k.availabilityStatus,caseCount:k.caseCount||0}),!0};for(let l=0;l<r.length;l++){const d=r[l],k=c[d];if(k&&ie(k))return h(d,l)}if(n){const l=Object.values(c).filter(d=>r.includes(d.id)?!1:ie(d)).sort((d,k)=>(d.caseCount||0)-(k.caseCount||0));if(l.length>0){const d=l[0];return console.log(`Assigning to fallback pharmacist ${d.name}`),h(d.id,r.length)}}console.log("No available pharmacists found"),S("No available pharmacists found. All pharmacists are unavailable or at capacity.")}catch(r){console.error("Error finding pharmacist:",r),S("Failed to find available pharmacist. Please try again.")}},u=s=>{const{name:t,value:r}=s.target;t!=="patientName"&&t!=="emrNumber"&&t!=="chiefComplaint"&&U(n=>({...n,[t]:r}))},w=()=>p.consultationType==="tele"?p.contactInfo.includes("meet.google.com"):/^\d{10}$/.test(p.contactInfo),j=async s=>{s.preventDefault(),S("");for(let t=0;t<p.patients.length;t++){const r=p.patients[t];if(!r.patientName.trim()){S(`Patient #${t+1} name is required`);return}if(!r.emrNumber.trim()){S(`Patient #${t+1} EMR number is required`);return}if(!r.chiefComplaint.trim()){S(`Patient #${t+1} chief complaint is required`);return}}if(!p.contactInfo.trim()){S(p.consultationType==="tele"?"Google Meet link is required":"Phone number is required");return}if(!w()){S(p.consultationType==="tele"?"Please enter a valid Google Meet link (should contain 'meet.google.com')":"Please enter a valid 10-digit phone number");return}if(!f){S("No doctor assigned. Please try again or contact support.");return}if(!g){S("No pharmacist assigned. Please contact support.");return}if(!se(f)){S("Assigned doctor is no longer available. Please wait for reassignment or refresh the page.");return}if(!ie(g)){S("Assigned pharmacist is no longer available. Please wait for reassignment or refresh the page.");return}Se(!0);try{const t=H(C,"users",A.uid),r=await I(t);if(!r.exists())throw new Error("Nurse data not found");const n=r.data(),i=Da(),o=Ma(C),c=[],x=`batch_${Date.now()}`;console.log(p.clinicCode);for(let b=0;b<p.patients.length;b++){const D=p.patients[b],h=`case_${Date.now()}_${b}`;c.push(h);const l=H(C,"cases",h),d={id:h,patientName:D.patientName,emrNumber:D.emrNumber,chiefComplaint:D.chiefComplaint,consultationType:p.consultationType,contactInfo:p.contactInfo,notes:p.notes,status:"pending",createdAt:i,createdBy:A.uid,createdByName:A.displayName||n.name,clinicId:A.uid,clinicName:n.name,clinicCode:n.clinicCode,manualClinicCode:p.clinicCode||"N/A",partnerName:n.partnerName,assignedDoctors:{primary:f.id,primaryName:f.name,primaryType:f.type,primaryStatus:f.availabilityStatus},pharmacistId:g.id,pharmacistName:g.name,pharmacistType:g.type||"primary",pharmacistStatus:g.availabilityStatus,doctorCompleted:!1,pharmacistCompleted:!1,doctorCompletedAt:null,pharmacistCompletedAt:null,isIncomplete:!1,inPharmacistPendingReview:!1,batchCreated:!0,batchTimestamp:i,batchSize:p.patients.length,batchIndex:b,batchCode:x};o.set(l,d)}if(f){const b=H(C,"users",f.id),D=await I(b);if(D.exists()){const h=D.data();(h.caseCount||0)+p.patients.length>=10&&h.availabilityStatus==="available"&&o.update(b,{availabilityStatus:"busy",lastStatusUpdate:i,autoStatusChange:!0})}}if(g){const b=H(C,"users",g.id),D=await I(b);if(D.exists()){const h=D.data();(h.caseCount||0)+p.patients.length>=10&&h.availabilityStatus==="available"&&o.update(b,{availabilityStatus:"busy",lastStatusUpdate:i,autoStatusChange:!0})}}await o.commit(),U({patients:[{patientName:"",emrNumber:"",chiefComplaint:""}],consultationType:"tele",contactInfo:"",notes:""}),T({id:c[0],allIds:c})}catch(t){console.error("Error creating cases:",t),S(t.message||"Failed to create cases")}finally{Se(!1)}},y=s=>{switch(s){case"available":return e.jsx(Ne,{className:"h-4 w-4 text-green-600"});case"busy":return e.jsx(ca,{className:"h-4 w-4 text-red-600"});case"unavailable":return e.jsx(da,{className:"h-4 w-4 text-gray-600"});case"on_break":return e.jsx(oa,{className:"h-4 w-4 text-amber-600"});default:return e.jsx(Ne,{className:"h-4 w-4 text-blue-600"})}},E=async()=>{z(!0),S("");try{ce&&(await fe(ce),await a(ce))}catch(s){console.error("Error refreshing assignments:",s),S("Failed to refresh assignments. Please try again.")}finally{z(!1)}};return e.jsxs(Aa,{className:"border border-gray-100 shadow-md",children:[e.jsx(ka,{className:"bg-gray-50 pb-4",children:e.jsxs(Ta,{className:"text-xl flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx($e,{className:"h-5 w-5 text-blue-600 mr-2"}),"Create New Case"]}),e.jsxs(P,{type:"button",variant:"outline",size:"sm",onClick:E,disabled:X,className:"flex items-center text-sm",children:[e.jsx(Fe,{className:`h-4 w-4 mr-1 ${X?"animate-spin":""}`}),"Refresh"]})]})}),e.jsxs(Ea,{className:"pt-6",children:[me&&e.jsxs(ea,{variant:"destructive",className:"mb-6",children:[e.jsx(Me,{className:"h-4 w-4"}),e.jsx(aa,{children:me})]}),X&&e.jsxs(ea,{className:"mb-6 border-amber-200 bg-amber-50",children:[e.jsx(Fe,{className:"h-4 w-4 animate-spin text-amber-600"}),e.jsx(aa,{className:"text-amber-800",children:"Reassigning healthcare professionals due to availability changes..."})]}),e.jsxs("form",{onSubmit:j,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"text-md font-medium flex items-center",children:[e.jsx(ye,{className:"h-4 w-4 mr-2 text-blue-500"}),"Patient Information",e.jsxs("span",{className:"ml-2 text-sm text-gray-500",children:["(",p.patients.length," patient",p.patients.length>1?"s":"",")"]})]}),p.patients.map((s,t)=>e.jsxs("div",{className:"p-4 border border-gray-200 rounded-md",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsxs("h4",{className:"text-sm font-semibold",children:["Patient #",t+1]}),p.patients.length>1&&e.jsx(P,{type:"button",variant:"outline",size:"sm",className:"h-8 border-red-200 text-red-600 hover:bg-red-50",onClick:()=>ma(t),children:"Remove"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:`patientName-${t}`,className:"text-sm",children:"Patient Name"}),e.jsx(re,{id:`patientName-${t}`,value:s.patientName,onChange:r=>we(t,"patientName",r.target.value),className:"focus:border-blue-300 focus:ring-blue-500",placeholder:"Enter patient's full name",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:`emrNumber-${t}`,className:"text-sm",children:"EMR Number (must be unique)"}),e.jsx(re,{id:`emrNumber-${t}`,value:s.emrNumber,onChange:r=>we(t,"emrNumber",r.target.value),className:"focus:border-blue-300 focus:ring-blue-500",placeholder:"Enter patient's EMR number",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:`chiefComplaint-${t}`,className:"text-sm",children:"Chief Complaint"}),e.jsx(re,{id:`chiefComplaint-${t}`,value:s.chiefComplaint,onChange:r=>we(t,"chiefComplaint",r.target.value),className:"focus:border-blue-300 focus:ring-blue-500",placeholder:"Enter chief complaint",required:!0})]})]})]},t)),e.jsxs(P,{type:"button",variant:"outline",className:"mt-2 border-blue-200 text-blue-600 hover:bg-blue-50",onClick:Re,children:[e.jsx(ye,{className:"h-4 w-4 mr-2"}),"Add Another Patient"]})]}),e.jsx(pa,{}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"text-md font-medium flex items-center",children:[e.jsx(Ba,{className:"h-4 w-4 mr-2 text-blue-500"}),"Case Details"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{className:"text-sm",children:"Consultation Type"}),e.jsxs($a,{defaultValue:"tele",className:"flex flex-col space-y-1 sm:flex-row sm:space-y-0 sm:space-x-6",value:p.consultationType,onValueChange:s=>U(t=>({...t,consultationType:s})),children:[e.jsxs("div",{className:"flex items-center space-x-2 p-2 rounded-md hover:bg-gray-50",children:[e.jsx(xa,{value:"tele",id:"tele",className:"text-blue-600"}),e.jsxs(B,{htmlFor:"tele",className:"flex items-center cursor-pointer",children:[e.jsx(sa,{className:"h-4 w-4 mr-2 text-blue-500"}),"Tele Consultation"]})]}),e.jsxs("div",{className:"flex items-center space-x-2 p-2 rounded-md hover:bg-gray-50",children:[e.jsx(xa,{value:"audio",id:"audio",className:"text-blue-600"}),e.jsxs(B,{htmlFor:"audio",className:"flex items-center cursor-pointer",children:[e.jsx(na,{className:"h-4 w-4 mr-2 text-blue-500"}),"Audio Consultation"]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"contactInfo",className:"text-sm flex items-center",children:p.consultationType==="tele"?e.jsxs(e.Fragment,{children:[e.jsx(sa,{className:"h-4 w-4 mr-2 text-blue-500"}),"Google Meet Link"]}):e.jsxs(e.Fragment,{children:[e.jsx(na,{className:"h-4 w-4 mr-2 text-blue-500"}),"Patient Phone Number"]})}),e.jsx(re,{id:"contactInfo",name:"contactInfo",type:p.consultationType==="tele"?"url":"tel",value:p.contactInfo,onChange:u,className:"focus:border-blue-300 focus:ring-blue-500",required:!0,placeholder:p.consultationType==="tele"?"https://meet.google.com/...":"10-digit phone number"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:p.consultationType==="tele"?"Must contain 'meet.google.com'":"Must be 10 digits"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(B,{htmlFor:"clinicCode",className:"text-sm flex items-center",children:[e.jsx(ia,{className:"h-4 w-4 mr-2 text-blue-500"}),"Add Clinic Code"]}),e.jsx(re,{id:"clinicCode",name:"clinicCode",value:p.manualClinicCode,onChange:u,className:"focus:border-blue-300 focus:ring-blue-500",placeholder:"Manually enter clinic code or leave blank"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(B,{htmlFor:"notes",className:"text-sm flex items-center",children:[e.jsx(Fa,{className:"h-4 w-4 mr-2 text-blue-500"}),"Additional Notes"]}),e.jsx("textarea",{id:"notes",name:"notes",rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-300 focus:outline-none",value:p.notes,onChange:u,placeholder:"Enter any additional information about the case"})]})]})]}),e.jsx(pa,{}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"text-md font-medium flex items-center",children:[e.jsx(Sa,{className:"h-4 w-4 mr-2 text-blue-500"}),"Assigned Healthcare Professionals",e.jsxs("span",{className:"ml-2 text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full flex items-center",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full mr-1 animate-pulse"}),"Live Status"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:"bg-blue-100 p-2 rounded-full",children:e.jsx(ta,{className:"h-5 w-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-500",children:"Assigned Doctor"}),f?e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-medium text-blue-700",children:f.name}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"text-xs bg-blue-50 text-blue-700 px-2 py-0.5 rounded-full border border-blue-200",children:f.type}),f.availabilityStatus&&e.jsx(Oa,{status:f.availabilityStatus,caseCount:f.caseCount}),!se(f)&&e.jsx("span",{className:"text-xs bg-red-100 text-red-700 px-1.5 py-0.5 rounded-full animate-pulse",children:"Reassigning..."})]})]}):ua?e.jsxs("div",{className:"text-amber-600 flex items-center space-x-1",children:[e.jsx(Me,{className:"h-4 w-4"}),e.jsx("span",{children:"No available doctor found"})]}):e.jsxs("div",{className:"flex items-center space-x-2 text-gray-500",children:[e.jsx(Ge,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{children:"Finding available doctor..."})]})]})]}),N.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsx("p",{className:"text-xs font-medium text-gray-500 mb-2",children:"All Doctors"}),e.jsx("div",{className:"space-y-2 max-h-[150px] overflow-y-auto",children:N.map(s=>(s.isHierarchy||Pe)&&e.jsxs("div",{className:"flex items-center justify-between bg-white p-2 rounded text-sm border border-gray-100",children:[e.jsxs("div",{className:"flex items-center",children:[y(s.availabilityStatus),e.jsx("span",{className:"ml-2",children:s.name}),s.isHierarchy&&e.jsx("span",{className:"ml-2 text-xs bg-blue-50 text-blue-700 px-1.5 py-0.5 rounded-full",children:s.isHierarchy})]}),e.jsxs("span",{className:`text-xs px-1.5 py-0.5 rounded-full ${(s.caseCount||0)>=10?"bg-red-100 text-red-800":"bg-green-100 text-green-800"}`,children:[s.caseCount||0,"/10"]})]},s.id))})]})]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:"bg-green-100 p-2 rounded-full",children:e.jsx(ra,{className:"h-5 w-5 text-green-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-500",children:"Assigned Pharmacist"}),g?e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-medium text-green-700",children:g.name}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"text-xs bg-green-50 text-green-700 px-2 py-0.5 rounded-full border border-green-200",children:g.type}),g.availabilityStatus&&e.jsx(Ua,{status:g.availabilityStatus,caseCount:g.caseCount}),!ie(g)&&e.jsx("span",{className:"text-xs bg-red-100 text-red-700 px-1.5 py-0.5 rounded-full animate-pulse",children:"Reassigning..."})]})]}):G?e.jsxs("div",{className:"text-amber-600 flex items-center space-x-1",children:[e.jsx(Me,{className:"h-4 w-4"}),e.jsx("span",{children:"No available pharmacist found"})]}):e.jsxs("div",{className:"flex items-center space-x-2 text-gray-500",children:[e.jsx(Ge,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{children:"Finding available pharmacist..."})]})]})]}),L.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsx("p",{className:"text-xs font-medium text-gray-500 mb-2",children:"All Pharmacists"}),e.jsx("div",{className:"space-y-2 max-h-[150px] overflow-y-auto",children:L.map(s=>(s.isHierarchy||he)&&e.jsxs("div",{className:"flex items-center justify-between bg-white p-2 rounded text-sm border border-gray-100",children:[e.jsxs("div",{className:"flex items-center",children:[y(s.availabilityStatus),e.jsx("span",{className:"ml-2",children:s.name}),s.isHierarchy&&e.jsx("span",{className:"ml-2 text-xs bg-green-50 text-green-700 px-1.5 py-0.5 rounded-full",children:s.isHierarchy})]}),e.jsxs("span",{className:`text-xs px-1.5 py-0.5 rounded-full ${(s.caseCount||0)>=10?"bg-red-100 text-red-800":"bg-green-100 text-green-800"}`,children:[s.caseCount||0,"/10"]})]},s.id))})]})]})]})]}),e.jsx("div",{className:"pt-4 flex justify-end",children:e.jsx(P,{type:"submit",disabled:Q||le||!f||!g||X||!se(f)||!ie(g),className:"bg-blue-600 hover:bg-blue-700 flex items-center",children:Q||le?e.jsxs(e.Fragment,{children:[e.jsx(Ge,{className:"h-4 w-4 mr-2 animate-spin"}),le?"Validating EMR...":"Creating..."]}):X?e.jsxs(e.Fragment,{children:[e.jsx(Fe,{className:"h-4 w-4 mr-2 animate-spin"}),"Reassigning..."]}):e.jsxs(e.Fragment,{children:[e.jsx($e,{className:"h-4 w-4 mr-2"}),"Create"," ",p.patients.length>1?`${p.patients.length} Cases`:"Case"]})})})]})]})]})},wa=20,Qa=5*60*1e3,Ya=({currentUser:A})=>{var Y;const[T,p]=m.useState([]),[U,V]=m.useState(!0),[W,je]=m.useState(!1),[ve,M]=m.useState(""),[de,Ce]=m.useState(!1),[Z,Re]=m.useState({}),[ma,we]=m.useState(null),[Q,Se]=m.useState(1),[le,ze]=m.useState(!1),[me,S]=m.useState(!1),[f,De]=m.useState(new Map),[g,ue]=m.useState(new Map),[ua,ha]=m.useState(1),[G,He]=m.useState(new Set),[N,F]=m.useState({open:!1,caseId:null,type:null,caseData:null,isIncomplete:!1,reason:""}),[L,K]=m.useState({open:!1,caseData:null}),[Pe,ne]=m.useState({open:!1,cases:[],batchTimestamp:null}),he=m.useCallback((a,u=1e3)=>{let w;return(...j)=>{clearTimeout(w),w=setTimeout(()=>a(...j),u)}},[]),_e=a=>{K({open:!0,caseData:a})},X=async(a,u=3)=>{let w;for(let j=0;j<u;j++)try{return await a()}catch(y){console.error(`Operation failed (attempt ${j+1}/${u}):`,y),w=y,await new Promise(E=>setTimeout(E,Math.pow(2,j)*100))}throw w},z=m.useCallback(async(a=1,u=!1)=>{const w=`${A.uid}-${a}`,j=Date.now();if(!u&&f.has(w)){const y=f.get(w);if(j-y.timestamp<Qa){p(y.data),Se(a),ze(y.hasNext),S(a>1),Re(y.linkedCases),V(!1);return}}try{V(a===1),a!==1&&je(!0);let y=R(_(C,"cases"),v("clinicId","==",A.uid),Ra("createdAt","desc"),Ha(wa+1));if(a>1&&g.has(a-1)){const i=g.get(a-1);y=R(y,_a(i))}const s=(await J(y)).docs,t=s.length>wa;t&&s.pop(),s.length>0&&g.set(a,s[s.length-1]);const r=[],n={};s.forEach(i=>{const o=i.data();if(o.batchCreated&&o.batchTimestamp){const c=o.batchTimestamp.toString();n[c]||(n[c]=[]),n[c].push({id:i.id,...ee(o)})}r.push({id:i.id,...ee(o)})}),f.set(w,{data:r,linkedCases:n,hasNext:t,timestamp:j}),p(r),Se(a),ze(t),S(a>1),Re(n)}catch(y){console.error("Error fetching cases:",y),M("Failed to load cases")}finally{V(!1),je(!1)}},[A.uid,f,g]),ee=m.useCallback(a=>({...a,createdAtFormatted:a.createdAt&&typeof a.createdAt.toDate=="function"?oe(a.createdAt.toDate(),"PPpp"):"Not available",createdAtDate:a.createdAt?oe(a.createdAt.toDate(),"PP"):"",createdAtTime:a.createdAt?oe(a.createdAt.toDate(),"p"):"",doctorCompletedAtFormatted:a.doctorCompletedAt?oe(a.doctorCompletedAt.toDate(),"PPpp"):null,pharmacistCompletedAtFormatted:a.pharmacistCompletedAt?oe(a.pharmacistCompletedAt.toDate(),"PPpp"):null}),[]);m.useEffect(()=>{z(1)},[z]);const Le=()=>{le&&z(Q+1)},ae=()=>{me&&z(Q-1)},pe=()=>{const a=`${A.uid}-${Q}`;f.delete(a),z(Q,!0)},ce=async a=>{a.preventDefault(),V(!0);try{const u=L.caseData,w={patientName:a.target.patientName.value,emrNumber:a.target.emrNumber.value,chiefComplaint:a.target.chiefComplaint.value,contactInfo:a.target.contactInfo.value,notes:a.target.notes.value},j=H(C,"cases",u.id);await ge(j,{...w,lastEdited:Da(),lastEditedBy:A.uid,lastEditedByName:A.displayName||"Nurse"}),K({open:!1,caseData:null}),pe()}catch(u){console.error("Error updating case:",u),M("Failed to update case")}finally{V(!1)}},qe=m.useMemo(()=>he(async a=>{if(!(!a||G.has(`doctor-${a}`))){G.add(`doctor-${a}`);try{const[u,w]=await Promise.all([I(H(C,"users",a)),J(R(_(C,"cases"),v("assignedDoctors.primary","==",a),v("doctorCompleted","==",!1),v("isIncomplete","!=",!0)))]);if(!u.exists())return;const j=u.data(),y=j.availabilityStatus,E=w.size;console.log(`Doctor ${a} has ${E} active cases, current status: ${y}`);const s=new Date,t=j.availabilityHistory||[];let r=!1,n=y,i=null;if(E>=10&&y==="available"?(n="busy",r=!0,i={previousStatus:y,newStatus:"busy",changedAt:s,reason:"Automatically marked as busy due to high case load (via nurse action)",casesNo:E}):E<10&&y==="busy"&&(n="available",r=!0,i={previousStatus:y,newStatus:"available",changedAt:s,reason:"Automatically marked as available due to reduced case load (via nurse action)",casesNo:E}),r&&i){const o=[i,...t].slice(0,50);await ge(H(C,"users",a),{availabilityStatus:n,lastStatusUpdate:s,availabilityHistory:o}),console.log(`Updated doctor ${a} status to ${n}`)}}catch(u){console.error("Error updating doctor status:",u)}finally{setTimeout(()=>{G.delete(`doctor-${a}`),He(new Set(G))},5e3)}}},1e3),[he,G]),se=m.useMemo(()=>he(async a=>{if(!(!a||G.has(`pharmacist-${a}`))){G.add(`pharmacist-${a}`);try{const[u,w]=await Promise.all([I(H(C,"users",a)),J(R(_(C,"cases"),v("pharmacistId","==",a),v("pharmacistCompleted","==",!1),v("isIncomplete","!=",!0)))]);if(!u.exists())return;const j=u.data(),y=j.availabilityStatus,E=w.size;console.log(`Pharmacist ${a} has ${E} active cases, current status: ${y}`);const s=new Date,t=j.availabilityHistory||[];let r=!1,n=y,i=null;if(E>=10&&y==="available"?(n="busy",r=!0,i={previousStatus:y,newStatus:"busy",changedAt:s,reason:"Automatically marked as busy due to high case load (via nurse action)",casesNo:E}):E<10&&y==="busy"&&(n="available",r=!0,i={previousStatus:y,newStatus:"available",changedAt:s,reason:"Automatically marked as available due to reduced case load (via nurse action)",casesNo:E}),r&&i){const o=[i,...t].slice(0,50);await ge(H(C,"users",a),{availabilityStatus:n,lastStatusUpdate:s,availabilityHistory:o}),console.log(`Updated pharmacist ${a} status to ${n}`)}}catch(u){console.error("Error updating pharmacist status:",u)}finally{setTimeout(()=>{G.delete(`pharmacist-${a}`),He(new Set(G))},5e3)}}},1e3),[he,G]),ie=async a=>{if(a)try{const u=H(C,"cases",a),w=await I(u);if(!w.exists())throw new Error("Case not found");const j=w.data();if(!j.doctorCompleted||!j.doctorCompletedAt){M("This case cannot be marked incomplete until the doctor has completed their review.");return}if(j.isIncomplete){M("This case has been marked as incomplete by the doctor and cannot be marked incomplete by you.");return}if(j.pharmacistCompleted){M("This case has already been completed.");return}const y=new Date,E=j.version||0;try{await X(()=>ge(u,{pharmacistCompleted:!0,inPharmacistPendingReview:!1,status:"pharmacist_incomplete",pharmacistCompletedAt:y,pharmacistCompletedBy:A.uid,pharmacistCompletedByName:A.displayName||"Nurse",version:E+1,isIncomplete:!0}));const s=j.pharmacistId;s&&await se(s),pe()}catch(s){console.error("Error updating case after retries:",s),M("Failed to update case after multiple attempts. Please try again.");return}we(null)}catch(u){console.error("Error completing case:",u),M("Failed to mark case as incomplete")}},Ae=async()=>{var a;try{const{caseId:u,type:w,isIncomplete:j,reason:y}=N;if(j&&!y.trim()){M("Please provide a reason for marking the case as incomplete.");return}const E=H(C,"cases",u),s=new Date,t=await I(E);if(!t.exists())throw new Error("Case not found");const r=t.data();if(w==="doctor"){const n={doctorCompleted:!0,status:j?"doctor_incomplete":"doctor_completed",doctorCompletedAt:s,doctorCompletedBy:A.uid,doctorCompletedByName:A.displayName||"Nurse",inPharmacistPendingReview:!j,version:(r.version||0)+1};j&&(n.isIncomplete=!0,n.incompleteReason=y);try{await X(()=>ge(E,n));const i=(a=r.assignedDoctors)==null?void 0:a.primary;i&&await qe(i)}catch(i){throw console.error("Error updating case after retries:",i),M("Failed to update case after multiple attempts. Please try again."),i}}else if(w==="pharmacist"){if(!r.doctorCompleted||!r.doctorCompletedAt){M("The doctor must complete this case before the pharmacist can be marked as complete."),F({open:!1,caseId:null,type:null,caseData:null,isIncomplete:!1,reason:""});return}if(r.isIncomplete){M("This case has been marked as incomplete by the doctor and cannot be completed."),F({open:!1,caseId:null,type:null,caseData:null,isIncomplete:!1,reason:""});return}if(r.pharmacistCompleted){M("This case has already been completed by a pharmacist."),F({open:!1,caseId:null,type:null,caseData:null,isIncomplete:!1,reason:""});return}const n={pharmacistCompleted:!0,status:j?"pharmacist_incomplete":"completed",pharmacistCompletedAt:s,pharmacistCompletedBy:A.uid,pharmacistCompletedByName:A.displayName||"Nurse",version:(r.version||0)+1};j&&(n.isIncomplete=!0,n.incompleteReason=y);try{await X(()=>ge(E,n));const i=r.pharmacistId;i&&await se(i)}catch(i){throw console.error("Error updating case after retries:",i),M("Failed to update case after multiple attempts. Please try again."),i}}F({open:!1,caseId:null,type:null,caseData:null,isIncomplete:!1,reason:""}),pe()}catch(u){console.error("Error completing case:",u),M("Failed to complete case"),F({open:!1,caseId:null,type:null,caseData:null,isIncomplete:!1,reason:""})}},ke=(a,u,w)=>{F({open:!0,caseId:a,type:u,caseData:w,isIncomplete:!0,reason:""})},Oe=()=>{Ce(!1),De(new Map),ue(new Map),z(1,!0)},xe=(a,u,w)=>{F({open:!0,caseId:a,type:u,caseData:w,isIncomplete:!1,reason:""})},Ue=a=>{Z[a]&&ne({open:!0,cases:Z[a],batchTimestamp:a})},Ve=a=>{switch(a){case"completed":return"success";case"doctor_completed":return"secondary";case"doctor_incomplete":case"pharmacist_incomplete":case"incomplete":return"destructive";default:return"outline"}},Te=a=>{switch(a){case"completed":return"Completed";case"doctor_completed":return"Doctor Completed";case"doctor_incomplete":return"Doctor Incomplete";case"pharmacist_incomplete":return"Pharmacist Incomplete";case"incomplete":return"Incomplete";default:return"Pending"}},Qe=a=>{if(a.batchCreated&&a.batchTimestamp){const u=a.batchTimestamp.toString();return Z[u]&&Z[u].length>1}return!1},fe=a=>{if(a.batchCreated&&a.batchTimestamp){const u=a.batchTimestamp.toString();return Z[u]?Z[u].length:0}return 0};return U&&Q===1?e.jsx("div",{className:"flex justify-center items-center min-h-[200px]",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx($e,{className:"h-5 w-5 text-blue-500"}),e.jsx("h2",{className:"text-xl font-semibold",children:"Case Management"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(P,{variant:"outline",size:"sm",onClick:pe,disabled:W,className:"flex items-center",children:[e.jsx(Fe,{className:`h-4 w-4 mr-2 ${W?"animate-spin":""}`}),"Refresh"]}),e.jsx(P,{onClick:()=>Ce(!de),className:"bg-blue-600 hover:bg-blue-700",children:de?"View Cases":"Create New Case"})]})]}),ve&&e.jsxs(ea,{variant:"destructive",children:[e.jsx(Me,{className:"h-4 w-4"}),e.jsx(aa,{children:ve})]}),de?e.jsx(Va,{currentUser:A,onCreateCase:Oe}):e.jsxs("div",{className:"bg-white rounded-lg shadow-md overflow-hidden border border-gray-100",children:[(T.length>0||Q>1)&&e.jsxs("div",{className:"flex justify-between items-center p-4 border-b border-gray-100 bg-gray-50",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("span",{className:"text-sm text-gray-600",children:["Page ",Q," â€¢ Showing ",T.length," cases"]}),W&&e.jsxs("div",{className:"flex items-center text-sm text-gray-500",children:[e.jsx(Fe,{className:"h-3 w-3 mr-1 animate-spin"}),"Refreshing..."]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(P,{variant:"outline",size:"sm",onClick:ae,disabled:!me||W,className:"flex items-center",children:[e.jsx(fa,{className:"h-4 w-4 mr-1"}),"Previous"]}),e.jsxs(P,{variant:"outline",size:"sm",onClick:Le,disabled:!le||W,className:"flex items-center",children:["Next",e.jsx(ba,{className:"h-4 w-4 ml-1"})]})]})]}),T.length===0&&Q===1?e.jsx("div",{className:"p-8 text-center text-gray-500",children:e.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[e.jsx($e,{className:"h-12 w-12 text-gray-300"}),e.jsx("p",{className:"text-lg",children:"No cases found. Create your first case to get started."}),e.jsx(P,{onClick:()=>Ce(!0),className:"mt-2 bg-blue-600 hover:bg-blue-700",children:"Create New Case"})]})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ga,{children:[e.jsx(ya,{className:"bg-gray-50",children:e.jsxs(Be,{children:[e.jsx(q,{className:"font-semibold",children:"Patient"}),e.jsx(q,{className:"font-semibold",children:"EMR"}),e.jsx(q,{className:"font-semibold",children:"Complaint"}),e.jsx(q,{className:"font-semibold",children:"Assigned To"}),e.jsx(q,{className:"font-semibold",children:"Type"}),e.jsx(q,{className:"font-semibold",children:"Created"}),e.jsx(q,{className:"font-semibold",children:"Status"}),e.jsx(q,{className:"font-semibold",children:"Actions"})]})}),e.jsx(Na,{children:T.map(a=>{var u,w;return e.jsxs(Be,{className:"hover:bg-gray-50",children:[e.jsx(O,{className:"font-medium",children:e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(ye,{className:"h-4 w-4 text-gray-400 mr-2"}),a.patientName,Qe(a)&&e.jsxs($,{variant:"outline",className:"ml-2 text-xs cursor-pointer hover:bg-blue-50",onClick:()=>Ue(a.batchTimestamp.toString()),children:[e.jsx(Ca,{className:"h-3 w-3 mr-1"}),"Batch (",fe(a),")"]})]}),a.batchCreated&&e.jsxs("div",{className:"text-xs text-gray-500",children:["Patient ",a.batchIndex+1," of"," ",a.batchSize]})]})}),e.jsx(O,{children:a.emrNumber}),e.jsx(O,{className:"max-w-[150px] truncate",children:a.chiefComplaint}),e.jsx(O,{children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center text-sm",children:[e.jsx(ta,{className:"h-3.5 w-3.5 text-blue-500 mr-1.5"}),((u=a.assignedDoctors)==null?void 0:u.primaryName)||"No doctor assigned",((w=a.assignedDoctors)==null?void 0:w.primaryType)&&e.jsxs("span",{className:"ml-1 text-xs bg-blue-50 text-blue-700 px-1 rounded",children:["(",a.assignedDoctors.primaryType,")"]}),e.jsx(P,{variant:"ghost",onClick:()=>{},type:"button",children:e.jsx(ia,{className:"!h-3.5 !w-3.5"})})]}),e.jsxs("div",{className:"flex items-center text-sm",children:[e.jsx(ra,{className:"h-3.5 w-3.5 text-green-500 mr-1.5"}),a.pharmacistName||"No pharmacist assigned",e.jsx(P,{variant:"ghost",onClick:()=>{},type:"button",children:e.jsx(ia,{className:"!h-3.5 !w-3.5"})})]})]})}),e.jsxs(O,{children:[e.jsx($,{variant:a.consultationType==="tele"?"default":"outline",className:a.consultationType==="tele"?"bg-indigo-100 text-indigo-800 hover:bg-indigo-100":"",children:a.consultationType==="tele"?"Tele":"Audio"}),a.consultationType==="audio"&&e.jsx("div",{className:"mt-1 text-sm text-gray-600",children:a.contactInfo})]}),e.jsx(O,{children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center text-xs text-gray-500",children:[e.jsx(ja,{className:"h-3 w-3 mr-1"}),e.jsx("span",{children:a.createdAtDate})]}),e.jsxs("div",{className:"flex items-center text-xs text-gray-500",children:[e.jsx(va,{className:"h-3 w-3 mr-1"}),e.jsx("span",{children:a.createdAtTime})]})]})}),e.jsx(O,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{variant:Ve(a.status),className:a.status==="completed"?"bg-green-100 text-green-800 hover:bg-green-100":a.status==="doctor_completed"?"bg-blue-100 text-blue-800 hover:bg-blue-100":"",children:Te(a.status)}),e.jsxs("div",{className:"space-y-1",children:[a.doctorCompletedAtFormatted&&e.jsxs("div",{className:"flex items-center text-xs text-gray-500",children:[e.jsx(te,{className:"h-3 w-3 mr-1 text-blue-500"}),e.jsxs("span",{children:["Doc:"," ",oe(new Date(a.doctorCompletedAt.toDate()),"p")]})]}),a.pharmacistCompletedAtFormatted&&e.jsxs("div",{className:"flex items-center text-xs text-gray-500",children:[e.jsx(te,{className:"h-3 w-3 mr-1 text-green-500"}),e.jsxs("span",{children:["Pharm:"," ",oe(new Date(a.pharmacistCompletedAt.toDate()),"p")]})]}),a.doctorCompletedByName&&e.jsxs("div",{className:"flex items-center text-xs text-gray-500",children:[e.jsx(ye,{className:"h-3 w-3 mr-1 text-gray-400"}),e.jsxs("span",{children:["By: ",a.doctorCompletedByName]})]})]})]})}),e.jsx(O,{children:e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs(P,{variant:"outline",size:"sm",className:"flex items-center text-gray-600 border-gray-200 hover:bg-gray-50",onClick:()=>_e(a),children:[e.jsx(Ze,{className:"h-4 w-4 mr-1"})," Edit Case"]}),a.consultationType==="tele"?e.jsx(P,{variant:"outline",size:"sm",className:"flex items-center text-indigo-600 border-indigo-200 hover:bg-indigo-50",asChild:!0,children:e.jsxs("a",{href:a.contactInfo,target:"_blank",rel:"noopener noreferrer",children:[e.jsx(sa,{className:"h-4 w-4 mr-1"})," Join Video"]})}):e.jsx(P,{variant:"outline",size:"sm",className:"flex items-center text-blue-600 border-blue-200 hover:bg-blue-50",asChild:!0,children:e.jsxs("a",{href:`tel:${a.contactInfo}`,children:[e.jsx(na,{className:"h-4 w-4 mr-1"})," Call Patient"]})}),!a.doctorCompleted&&e.jsxs(e.Fragment,{children:[e.jsxs(P,{variant:"outline",size:"sm",className:"flex items-center text-blue-600 border-blue-200 hover:bg-blue-50",onClick:()=>xe(a.id,"doctor",a),children:[e.jsx(te,{className:"h-4 w-4 mr-1"})," Mark Doctor Done"]}),e.jsxs(P,{variant:"outline",size:"sm",className:"flex items-center text-red-600 border-red-200 hover:bg-red-50",onClick:()=>ke(a.id,"doctor",a),children:[e.jsx(Ee,{className:"h-4 w-4 mr-1"})," Mark as Incomplete"]})]}),a.doctorCompleted&&!a.pharmacistCompleted&&!a.isIncomplete&&e.jsxs(e.Fragment,{children:[e.jsxs(P,{variant:"outline",size:"sm",className:"flex items-center text-red-600 border-red-200 hover:bg-red-50",onClick:()=>ie(a.id),children:[e.jsx(Ee,{className:"h-4 w-4 mr-1"})," Mark Pharm Incomplete"]}),e.jsxs(P,{variant:"outline",size:"sm",className:"flex items-center text-green-600 border-green-200 hover:bg-green-50",onClick:()=>xe(a.id,"pharmacist",a),children:[e.jsx(te,{className:"h-4 w-4 mr-1"})," Mark Pharm Done"]})]}),!a.doctorCompleted&&!a.pharmacistCompleted&&e.jsxs(P,{variant:"outline",size:"sm",className:"flex items-center text-gray-400 border-gray-200 cursor-not-allowed opacity-50",disabled:!0,title:"Doctor must complete before pharmacist",children:[e.jsx(te,{className:"h-4 w-4 mr-1"})," Mark Pharm Done"]}),a.isIncomplete&&e.jsxs("div",{className:"mt-1 text-xs text-red-600 flex items-center",children:[e.jsx(Ee,{className:"h-3.5 w-3.5 mr-1"}),"Marked incomplete - ",e.jsx("br",{})," No further action needed"]})]})})]},a.id)})})]})}),e.jsxs("div",{className:"flex justify-between items-center p-4 border-t border-gray-100 bg-gray-50",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:["Showing ",T.length," cases on page ",Q]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(P,{variant:"outline",size:"sm",onClick:ae,disabled:!me||W,className:"flex items-center",children:[e.jsx(fa,{className:"h-4 w-4 mr-1"}),"Previous"]}),e.jsxs(P,{variant:"outline",size:"sm",onClick:Le,disabled:!le||W,className:"flex items-center",children:["Next",e.jsx(ba,{className:"h-4 w-4 ml-1"})]})]})]})]})]}),e.jsx(Ke,{open:N.open,onOpenChange:a=>F({...N,open:a}),children:e.jsxs(Xe,{className:"sm:max-w-md",children:[e.jsxs(Ye,{children:[e.jsxs(Je,{className:"flex items-center",children:[N.isIncomplete?e.jsx(Ee,{className:"h-5 w-5 text-red-500 mr-2"}):e.jsx(te,{className:"h-5 w-5 text-green-500 mr-2"}),N.isIncomplete?"Mark as Incomplete":"Confirm Completion"," ","- ",N.type==="doctor"?"Doctor":"Pharmacist"]}),e.jsxs(Ie,{children:["Are you sure you want to mark this case as"," ",N.isIncomplete?"incomplete":"completed"," for the ",N.type,"?"]})]}),N.caseData&&e.jsxs("div",{className:"space-y-3 py-3 border-y border-gray-100",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(ye,{className:"h-4 w-4 text-gray-400 mr-2"}),e.jsx("span",{className:"font-medium",children:"Patient:"})," ",e.jsx("span",{className:"ml-2",children:N.caseData.patientName})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx($e,{className:"h-4 w-4 text-gray-400 mr-2"}),e.jsx("span",{className:"font-medium",children:"EMR:"})," ",e.jsx("span",{className:"ml-2",children:N.caseData.emrNumber})]}),e.jsxs("div",{className:"flex items-start",children:[e.jsx(Me,{className:"h-4 w-4 text-gray-400 mr-2 mt-0.5"}),e.jsx("span",{className:"font-medium",children:"Complaint:"})," ",e.jsx("span",{className:"ml-2",children:N.caseData.chiefComplaint})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(va,{className:"h-4 w-4 text-gray-400 mr-2"}),e.jsx("span",{className:"font-medium",children:"Created At:"})," ",e.jsx("span",{className:"ml-2",children:N.caseData.createdAtFormatted})]}),N.type==="pharmacist"&&N.caseData.doctorCompletedAtFormatted&&e.jsxs("div",{className:"flex items-center",children:[e.jsx(ja,{className:"h-4 w-4 text-gray-400 mr-2"}),e.jsx("span",{className:"font-medium",children:"Doctor Completed:"})," ",e.jsx("span",{className:"ml-2",children:N.caseData.doctorCompletedAtFormatted})]}),N.isIncomplete&&e.jsx("div",{className:"py-3 border-t border-gray-100 mb-2",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{htmlFor:"incompleteReason",className:"text-sm font-medium",children:["Reason for marking as incomplete"," ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("textarea",{id:"incompleteReason",rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Please explain why this case is being marked as incomplete...",value:N.reason,onChange:a=>F({...N,reason:a.target.value}),required:!0})]})}),((Y=N.caseData.assignedDoctors)==null?void 0:Y.primaryName)&&e.jsxs("div",{className:"flex items-center",children:[e.jsx(ta,{className:"h-4 w-4 text-blue-500 mr-2"}),e.jsx("span",{className:"font-medium",children:"Assigned Doctor:"})," ",e.jsxs("span",{className:"ml-2",children:[N.caseData.assignedDoctors.primaryName,N.caseData.assignedDoctors.primaryType&&e.jsxs("span",{className:"ml-1 text-xs bg-blue-50 text-blue-700 px-1 rounded",children:["(",N.caseData.assignedDoctors.primaryType,")"]})]})]}),N.caseData.pharmacistName&&e.jsxs("div",{className:"flex items-center",children:[e.jsx(ra,{className:"h-4 w-4 text-green-500 mr-2"}),e.jsx("span",{className:"font-medium",children:"Assigned Pharmacist:"})," ",e.jsx("span",{className:"ml-2",children:N.caseData.pharmacistName})]})]}),e.jsxs(We,{className:"sm:justify-between",children:[e.jsx(P,{variant:"outline",onClick:()=>F({open:!1,caseId:null,type:null,caseData:null,isIncomplete:!1,reason:""}),children:"Cancel"}),e.jsx(P,{onClick:Ae,disabled:N.isIncomplete&&!N.reason.trim(),className:N.isIncomplete?"bg-red-600 hover:bg-red-700 disabled:opacity-50":"bg-green-600 hover:bg-green-700",children:N.isIncomplete?e.jsxs(e.Fragment,{children:[e.jsx(Ee,{className:"h-4 w-4 mr-2"}),"Mark as Incomplete"]}):e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),"Confirm Completion"]})})]})]})}),e.jsx(Ke,{open:L.open,onOpenChange:a=>K({...L,open:a}),children:e.jsxs(Xe,{className:"sm:max-w-lg",children:[e.jsxs(Ye,{children:[e.jsxs(Je,{className:"flex items-center",children:[e.jsx(Ze,{className:"h-5 w-5 text-blue-500 mr-2"}),"Edit Case Details"]}),e.jsx(Ie,{children:"Update patient and case information"})]}),L.caseData&&e.jsxs("form",{onSubmit:ce,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"editPatientName",children:"Patient Name"}),e.jsx(re,{id:"editPatientName",name:"patientName",defaultValue:L.caseData.patientName,className:"focus:border-blue-300 focus:ring-blue-500"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"editEmrNumber",children:"EMR Number"}),e.jsx(re,{id:"editEmrNumber",name:"emrNumber",defaultValue:L.caseData.emrNumber,className:"focus:border-blue-300 focus:ring-blue-500"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"editChiefComplaint",children:"Chief Complaint"}),e.jsx(re,{id:"editChiefComplaint",name:"chiefComplaint",defaultValue:L.caseData.chiefComplaint,className:"focus:border-blue-300 focus:ring-blue-500"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"editContactInfo",children:L.caseData.consultationType==="tele"?"Google Meet Link":"Phone Number"}),e.jsx(re,{id:"editContactInfo",name:"contactInfo",defaultValue:L.caseData.contactInfo,className:"focus:border-blue-300 focus:ring-blue-500"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"editNotes",children:"Additional Notes"}),e.jsx("textarea",{id:"editNotes",name:"notes",rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-300 focus:outline-none",defaultValue:L.caseData.notes||""})]})]}),e.jsxs(We,{className:"pt-4",children:[e.jsx(P,{variant:"outline",onClick:()=>K({open:!1,caseData:null}),children:"Cancel"}),e.jsx(P,{type:"submit",className:"bg-blue-600 hover:bg-blue-700",children:"Save Changes"})]})]})]})}),e.jsx(Ke,{open:Pe.open,onOpenChange:a=>ne({...Pe,open:a}),children:e.jsxs(Xe,{className:"sm:max-w-3xl",children:[e.jsxs(Ye,{children:[e.jsxs(Je,{className:"flex items-center",children:[e.jsx(Ca,{className:"h-5 w-5 text-blue-500 mr-2"}),"Batch Cases"]}),e.jsx(Ie,{children:"All patients created in the same batch"})]}),e.jsxs("div",{className:"mt-4 border-t border-b border-gray-100 py-4",children:[e.jsxs("div",{className:"flex items-center mb-4 space-x-2",children:[e.jsx(Sa,{className:"h-4 w-4 text-blue-500"}),e.jsx("p",{className:"text-sm text-gray-600",children:"These cases were created together in the same batch and share the same contact information."})]}),e.jsx("div",{className:"overflow-x-auto max-h-[400px]",children:e.jsxs(ga,{children:[e.jsx(ya,{className:"bg-gray-50",children:e.jsxs(Be,{children:[e.jsx(q,{className:"font-semibold",children:"Patient"}),e.jsx(q,{className:"font-semibold",children:"EMR"}),e.jsx(q,{className:"font-semibold",children:"Complaint"}),e.jsx(q,{className:"font-semibold",children:"Status"}),e.jsx(q,{className:"font-semibold",children:"Actions"})]})}),e.jsx(Na,{children:Pe.cases.map(a=>e.jsxs(Be,{className:"hover:bg-gray-50",children:[e.jsx(O,{className:"font-medium",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(ye,{className:"h-4 w-4 text-gray-400 mr-2"}),a.patientName]})}),e.jsx(O,{children:a.emrNumber}),e.jsx(O,{className:"max-w-[200px] truncate",children:a.chiefComplaint}),e.jsx(O,{children:e.jsx($,{className:a.status==="completed"?"bg-green-100 text-green-800":a.status==="doctor_completed"?"bg-blue-100 text-blue-800":a.status==="doctor_incomplete"||a.status==="pharmacist_incomplete"?"bg-red-100 text-red-800":"bg-gray-100 text-gray-800",children:Te(a.status)})}),e.jsx(O,{children:e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs(P,{variant:"outline",size:"sm",className:"flex items-center text-gray-600 border-gray-200 hover:bg-gray-50",onClick:()=>{ne({open:!1,cases:[],batchTimestamp:null}),_e(a)},children:[e.jsx(Ze,{className:"h-4 w-4 mr-1"})," Edit"]}),!a.doctorCompleted&&e.jsxs(P,{variant:"outline",size:"sm",className:"flex items-center text-blue-600 border-blue-200 hover:bg-blue-50",onClick:()=>{ne({open:!1,cases:[],batchTimestamp:null}),xe(a.id,"doctor",a)},children:[e.jsx(te,{className:"h-4 w-4 mr-1"})," Dr Done"]}),a.doctorCompleted&&!a.pharmacistCompleted&&!a.isIncomplete&&e.jsxs(P,{variant:"outline",size:"sm",className:"flex items-center text-green-600 border-green-200 hover:bg-green-50",onClick:()=>{ne({open:!1,cases:[],batchTimestamp:null}),xe(a.id,"pharmacist",a)},children:[e.jsx(te,{className:"h-4 w-4 mr-1"})," Pharm Done"]})]})})]},a.id))})]})})]}),e.jsx(We,{children:e.jsx(P,{variant:"outline",onClick:()=>ne({open:!1,cases:[],batchTimestamp:null}),children:"Close"})})]})})]})};export{Ya as default};
